	  subroutine nrpiprd(e,ka,piso,chiso)
	  implicit none
C	  dimension piso(4,3),chiso(3)
	  real*4   e,piso(4,3),chiso(3)
	  integer*4 ka

c     
c     ka=  1 pi+ p, pi- n
c     2 pi+ n, pi- p
c     4 pi0 p, pi0 n
c     
#include "nrcms.h"

C	  common /nuccms/rhon,pfermi,unucl,ecms2,up4cms(3),beta(3),prot
C	  logical prot

	  real*4    fripn(117),fmxsp(117),pnmi(101)
C	  dimension fripn(117),fmxsp(117),pnmi(101)
	  real*4    pcfsl1(117),pcfsl2(117),pnfsl1(117),pnfsl2(117)
C	  dimension pcfsl1(117),pcfsl2(117),pnfsl1(117),pnfsl2(117)

	  real*4    dldir(3),pdl(4),pdldec(4,3),rc(5)
C	  dimension dldir(3),pdl(4),pdldec(4,3),rc(5)

	  real*4    upi,amnucl
	  parameter (upi=139.6, amnucl=939.)
	  data fripn/    
	1	   3.,  14.,  39.,  90., 181., 326., 540., 838.,1236.,1726.,
	2	   2259.,2732.,3135.,3484.,3784.,4036.,4242.,4410.,4549.,4669.,
	3	   4775.,4869.,4952.,5025.,5092.,5152.,5207.,5258.,5305.,5348.,
	4	   5388.,5426.,5461.,5496.,5530.,5564.,5599.,5636.,5674.,5714.,
	5	   5755.,5798.,5843.,5889.,5937.,5986.,6036.,6088.,6140.,6193.,
	6	   6246.,6299.,6353.,6406.,6459.,6513.,6566.,6621.,6676.,6733.,
	7	   6791.,6851.,6912.,6975.,7040.,7107.,7175.,7246.,7319.,7393.,
	8	   7467.,7542.,7617.,7691.,7765.,7838.,7909.,7979.,8048.,8114.,
	9	   8179.,8242.,8304.,8365.,8424.,8482.,8538.,8594.,8648.,8702.,
	1	   8754.,8806.,8857.,8907.,8957.,9007.,9057.,9106.,9154.,9202.,
	2	   9250.,9298.,9346.,9393.,9440.,9487.,9534.,9581.,9628.,9674.,
	3	   9721.,9767.,9814.,9860.,9907.,9954.,10000./

	  data fmxsp/    
	1	   53., 106., 150., 192., 233., 275., 318., 360., 403., 447.,
	2	   491., 536., 581., 627., 672., 718., 765., 811., 858., 905.,
	3	   953.,1000.,1048.,1096.,1144.,1192.,1240.,1288.,1336.,1385.,
	4	   1433.,1482.,1530.,1579.,1628.,1677.,1725.,1774.,1823.,1872.,
	5	   1921.,1970.,2019.,2068.,2116.,2165.,2214.,2263.,2312.,2361.,
	6	   2410.,2459.,2508.,2557.,2606.,2655.,2704.,2753.,2802.,2850.,
	7	   2899.,2948.,2997.,3046.,3095.,3144.,3192.,3241.,3290.,3339.,
	8	   3387.,3436.,3485.,3534.,3582.,3631.,3680.,3728.,3777.,3826.,
	9	   3874.,3923.,3971.,4020.,4069.,4117.,4166.,4214.,4263.,4311.,
	1	   4360.,4408.,4457.,4505.,4553.,4602.,4650.,4699.,4747.,4795.,
	2	   4844.,4892.,4940.,4989.,5037.,5085.,5134.,5182.,5230.,5278.,
	3	   5327.,5375.,5423.,5471.,5519.,5568.,5616./

	  data pnmi/     
	1	   1078.6,1134.,1149.,1159.,1166.,1173.,1178.,1183.,1188.,1192.,
	2	   1195.,1199.,1203.,1206.,1208.,1211.,1214.,1217.,1220.,1222.,
	3	   1225.,1227.,1230.,1233.,1236.,1238.,1241.,1244.,1247.,1251.,
	4	   1254.,1257.,1261.,1265.,1269.,1273.,1277.,1282.,1286.,1291.,
	5	   1297.,1303.,1309.,1316.,1324.,1333.,1342.,1353.,1366.,1380.,
	6	   1395.,1413.,1434.,1458.,1486.,1519.,1551.,1580.,1606.,1629.,
	7	   1651.,1671.,1691.,1710.,1729.,1748.,1766.,1784.,1801.,1817.,
	8	   1832.,1846.,1860.,1873.,1886.,1898.,1910.,1923.,1935.,1948.,
	9	   1960.,1974.,1987.,2002.,2016.,2031.,2047.,2062.,2079.,2095.,
	1	   2112.,2129.,2146.,2163.,2180.,2197.,2215.,2232.,2249.,2265.,
	2	   2282./

	  data pcfsl1/   
	1	   9000.,1800.,  56.,1430.,4860.,6480.,7079.,7263.,7425.,7455.,
	2	   7268.,7104.,6772.,6363.,5685.,4962.,4709.,3776.,3904.,5056.,
	3	   5131.,4892.,4933.,4781.,4417.,3887.,3309.,3140.,3507.,4142.,
	4	   4671.,5104.,5554.,5893.,5927.,5828.,5730.,5651.,5544.,5406.,
	5	   5261.,5106.,4964.,4748.,4665.,4662.,4768.,4886.,5009.,5149.,
	6	   5263.,5406.,5518.,5630.,5714.,5779.,5860.,5911.,5981.,6023.,
	7	   6070.,6124.,6155.,6191.,6204.,6238.,6236.,6245.,6232.,6208.,
	8	   6210.,6203.,6199.,6211.,6218.,6241.,6258.,6297.,6329.,6263.,
	9	   6453.,6524.,6606.,6691.,6744.,6797.,6854.,6897.,6942.,6972.,
	1	   7001.,7043.,7068.,7106.,7135.,7158.,7192.,7247.,7300.,7300.,
	2	   7335.,7358.,7389.,7420.,7444.,7481.,7505.,7522.,7547.,7565.,
	3	   7595.,7612.,7627.,7650.,7665.,7687.,7759./

	  data pcfsl2/   
	1	   11000.,6200.,4926.,5820.,8100.,9190.,9605.,9721.,9825.,9838.,
	2	   9703.,9576.,9333.,9045.,8574.,8079.,7898.,7268.,7367.,8186.,
	3	   8232.,8045.,8044.,7886.,7560.,7113.,6613.,6431.,6665.,7124.,
	4	   7514.,7836.,8183.,8445.,8459.,8367.,8280.,8217.,8148.,8053.,
	5	   7958.,7830.,7678.,7461.,7346.,7298.,7327.,7386.,7439.,7506.,
	6	   7561.,7636.,7706.,7780.,7851.,7917.,7986.,8020.,8064.,8083.,
	7	   8117.,8162.,8190.,8226.,8251.,8297.,8320.,8337.,8334.,8322.,
	8	   8326.,8317.,8321.,8329.,8335.,8352.,8366.,8394.,8420.,8382.,
	9	   8519.,8575.,8643.,8711.,8753.,8793.,8832.,8863.,8890.,8907.,
	1	   8921.,8942.,8953.,8973.,8986.,8995.,9013.,9039.,9055.,9070.,
	2	   9089.,9098.,9112.,9127.,9135.,9153.,9162.,9168.,9180.,9186.,
	3	   9201.,9208.,9211.,9220.,9225.,9234.,9276./

	  data pnfsl1/   
	1	   7000.,   0.,   0.,   0.,2146.,4013.,4700.,4934.,5134.,5181.,
	2	   4979.,4820.,4484.,4062.,3366.,2619.,2392.,1426.,1499.,2559.,
	3	   2658.,2496.,2642.,2676.,2588.,2389.,2236.,2300.,2621.,3042.,
	4	   3394.,3685.,3978.,4207.,4253.,4214.,4169.,4118.,4022.,3911.,
	5	   3783.,3702.,3702.,3672.,3724.,3804.,3953.,4069.,4200.,4335.,
	6	   4442.,4564.,4647.,4723.,4763.,4782.,4821.,4855.,4907.,4945.,
	7	   4976.,5004.,5018.,5029.,5022.,5022.,4994.,4989.,4972.,4950.,
	8	   4950.,4949.,4939.,4947.,4951.,4966.,4975.,5002.,5021.,4964.,
	9	   5096.,5140.,5188.,5241.,5274.,5310.,5352.,5385.,5421.,5447.,
	1	   5474.,5511.,5533.,5569.,5595.,5617.,5647.,5696.,5749.,5738.,
	2	   5768.,5789.,5816.,5842.,5865.,5896.,5917.,5933.,5953.,5970.,
	3	   5994.,6008.,6023.,6043.,6055.,6074.,6127./

	  data pnfsl2/   
	1	   13000.,   0.,   0.,   0.,4996.,7858.,8937.,9253.,9533.,9571.,
	2	   9221.,8905.,8307.,7607.,6483.,5310.,4920.,3441.,3606.,5405.,
	3	   5537.,5177.,5284.,5125.,4714.,4141.,3621.,3559.,4019.,4729.,
	4	   5340.,5857.,6414.,6855.,6902.,6773.,6650.,6549.,6411.,6235.,
	5	   6046.,5864.,5730.,5530.,5487.,5521.,5669.,5810.,5957.,6117.,
	6	   6243.,6396.,6512.,6625.,6708.,6772.,6855.,6907.,6980.,7023.,
	7	   7073.,7130.,7162.,7201.,7217.,7256.,7257.,7268.,7254.,7229.,
	8	   7232.,7223.,7220.,7232.,7241.,7267.,7285.,7329.,7366.,7293.,
	9	   7508.,7591.,7689.,7790.,7854.,7917.,7983.,8034.,8084.,8117.,
	1	   8147.,8190.,8210.,8253.,8282.,8303.,8338.,8392.,8436.,8447.,
	2	   8482.,8502.,8532.,8560.,8581.,8615.,8635.,8649.,8671.,8686.,
	3	   8713.,8727.,8737.,8756.,8767.,8785.,8855./

	  real*4 t,w,erem,r,r1,phsm,erem1,amd,ed,pd2,pdlt,phs,cdl
	  real*4 v1,v2,v3,v4
	  integer*4 ilo,ihi,ilo1,ihi1,i,k

	  real*4   ranf
	  external ranf

	  t=e-upi
	  w=sqrt(ecms2)
	  call nrhis(t-180.,20.,117,ilo,ihi,erem)
	  r1  =(fripn(ihi)*erem+fripn(ilo)*(1-erem))*1e-4
	  phsm=(fmxsp(ihi)*erem+fmxsp(ilo)*(1-erem))*100.
 1	  r=r1*ranf()
	  call nrhis(r*100.,1.,101,ilo1,ihi1,erem1)
	  amd=pnmi(ihi1)*erem1+pnmi(ilo1)*(1-erem1)
	  ed=(amd**2+ecms2-upi**2)/(2*w)
	  pd2=ed**2-amd**2
	  if(pd2.lt.0.)go to 1
	  pdlt=sqrt(pd2)
	  phs=(w-ed)*ed*pdlt/w
	  if(ranf().gt.phs/phsm)go to 1

	  if(ka.eq.1)then			!pi+p,pi-n
		 if(ranf().gt.0.75)then	!backward 25%
			cdl=-0.9999995
		 else					!isotropic 75%
			cdl=2*ranf()-1
		 end if
	  else						!pi+n,pi-p,pi0p,pi0n
		 if(ranf().gt.0.80)then
			cdl=-0.9999995		!e>500 -backward 20%
			if(t.lt.500.)cdl=-cdl !e<500 -forward  20%
		 else
			cdl=2*ranf()-1		!isotropic 80%
		 end if
	  end if
	  call nrcone(up4cms,dldir,cdl,-1.)
	  do i=1,3
		 pdl(i)=pdlt*dldir(i)	!delta momentum
		 pdldec(i,3)=-pdl(i)	!pion momentum (leading pi)
	  end do
	  pdl(4)=ed
	  pdldec(4,3)=w-ed
	  call twobiso(amd,amnucl,upi,pdl,pdldec) !delta decay isotropic 1=nuc
	  do i=1,3					!go back to lab
		 call nrlloren(piso(1,i),piso(4,i),pdldec(1,i),pdldec(4,i),beta)
	  end do

c     ********* distribute charges ******
	  r=ranf()
	  if(ka.eq.1)then
		 rc(1)=0.1333
		 rc(2)=0.4
		 rc(3)=1.
		 do k=1,3
			if(r.le.rc(k))go to 101
		 end do
		 k=3
 101	 continue
		 if(prot)then			!pi+p
			go to (102,103,104)k
 102		chiso(1)=0			!pi+pi+n
			chiso(2)=1
			chiso(3)=1
			go to 105
 103		chiso(1)=1			!pi+pi0p
			chiso(2)=0
			chiso(3)=1
			go to 105
 104		chiso(1)=1			!pi0pi+p
			chiso(2)=1
			chiso(3)=0
 105		continue
		 else					!pi-n
			go to (106,107,108)k
 106		chiso(1)=1			!pi-pi-p
			chiso(2)=-1
			chiso(3)=-1
			go to 109
 107		chiso(1)=0			!pi-pi0n
			chiso(2)=0
			chiso(3)=-1
			go to 109
 108		chiso(1)=0			!pi0pi-n
			chiso(2)=-1
			chiso(3)=0
 109		continue
		 end if
	  else if(ka.eq.2)then
		 v1=(pcfsl1(ihi)*erem+pcfsl1(ilo)*(1-erem))*1e-4
		 v2=(pcfsl2(ihi)*erem+pcfsl2(ilo)*(1-erem))*1e-4
		 v3=(1-v1)*v2/3
		 v4=(1-v1)/3-v3
		 rc(1)=v1
		 rc(2)=rc(1)+v4
		 rc(3)=rc(2)+v3
		 rc(4)=rc(3)+v4*2
		 rc(5)=1
		 do k=1,5
			if(r.le.rc(k))go to 201
		 end do
		 k=5
 201	 continue
		 if(prot)then			!pi-p
			go to (202,203,204,205,206)k
 202		chiso(1)=0			!pi+pi-n
			chiso(2)=-1
			chiso(3)=1
			go to 208
 203		chiso(1)=0			!pi-pi+n
			chiso(2)=1
			chiso(3)=-1
			go to 208
 204		chiso(1)=1			!pi0pi-p
			chiso(2)=-1
			chiso(3)=0
			go to 208
 205		chiso(1)=1			!pi-pi0p
			chiso(2)=0
			chiso(3)=-1
			go to 208
 206		chiso(1)=0			!pi0pi0n
			chiso(2)=0
			chiso(3)=0
 208		continue
		 else					!pi+n
			go to (212,213,214,215,216)k
 212		chiso(1)=1			!pi-pi+p
			chiso(2)=1
			chiso(3)=-1
			go to 218
 213		chiso(1)=1			!pi+pi-p
			chiso(2)=-1
			chiso(3)=1
			go to 218
 214		chiso(1)=0			!pi0pi+n
			chiso(2)=1
			chiso(3)=0
			go to 218
 215		chiso(1)=0			!pi+pi0n
			chiso(2)=0
			chiso(3)=1
			go to 218
 216		chiso(1)=1			!pi0pi0p
			chiso(2)=0
			chiso(3)=0
 218		continue
		 end if
	  else
		 v1=(pnfsl1(ihi)*erem+pnfsl1(ilo)*(1-erem))*1e-4
		 v2=(pnfsl2(ihi)*erem+pnfsl2(ilo)*(1-erem))*1e-4
		 v3=(1-v1)*v2/3
		 v4=(1-v1)-3*v3
		 rc(1)=v1/3
		 rc(2)=rc(1)+v4
		 rc(3)=rc(2)+2*rc(1)
		 rc(4)=rc(3)+v3
		 rc(5)=1
		 do k=1,5
			if(r.lt.rc(k))go to 301
		 end do
		 k=5
 301	 continue
		 if(prot)then			!pi0p
			go to (302,303,304,305,306)k
 302		chiso(1)=1			!pi+pi-p
			chiso(2)=-1
			chiso(3)=1
			go to 308
 303		chiso(1)=1			!pi-pi+p
			chiso(2)=1
			chiso(3)=-1
			go to 308
 304		chiso(1)=0			!pi+pi0n
			chiso(2)=0
			chiso(3)=1
			go to 308
 305		chiso(1)=0			!pi0pi+n
			chiso(2)=1
			chiso(3)=0
			go to 308
 306		chiso(1)=1			!pi0pi0p
			chiso(2)=0
			chiso(3)=0
 308		continue
		 else					!pi0n
			go to (312,313,314,315,316)k
 312		chiso(1)=0			!pi-pi+n
			chiso(2)=1
			chiso(3)=-1
			go to 318
 313		chiso(1)=0			!pi+pi-n
			chiso(2)=-1
			chiso(3)=1
			go to 318
 314		chiso(1)=1			!pi-pi0p
			chiso(2)=0
			chiso(3)=-1
			go to 318
 315		chiso(1)=1			!pi0pi-p
			chiso(2)=-1
			chiso(3)=0
			go to 318
 316		chiso(1)=0			!pi0pi0n
			chiso(2)=0
			chiso(3)=0
 318		continue
		 end if
	  end if
	  return
	  end
